# 对话复盘学习文档（Flutter 界面与交互优化）

## 一、背景与目标

本次对话围绕一个 Flutter 项目的「界面与交互质量」展开，目标从“先测试检查”逐步扩展到“定位并修复实际问题”，最终形成了包含可复现验证、性能优化、交互体验增强与测试补齐的一整套执行闭环。

核心目标可归纳为：

- 验证当前 UI/交互是否稳定可用；
- 修复用户在真实运行中遇到的崩溃与体验问题；
- 提升 Web 首屏与交互性能；
- 补齐自动化测试，降低回归风险；
- 给出可持续执行的后续动作。

---

## 二、已完成事项（按时间顺序）

1. **完成首轮界面与交互体检**
   - 并行收集代码上下文、现有测试覆盖、外部最佳实践。
   - 执行 `flutter test`、`flutter analyze`、`flutter build web`。
   - 结论：工程可构建、静态检查通过，但 UI 交互自动化覆盖不足。

2. **补充高价值 Widget 测试（从 1 条扩展到多条）**
   - 补充了底部导航切换、Search 展示、Saved 空态回 Home、Profile 分区展示、文章卡片进入详情并返回等。
   - 处理了测试稳定性（`SharedPreferences` mock、滚动可见、`pumpAndSettle` 等）。

3. **定位并修复底部栏 hover 异常“小方块”**
   - 原因是 Web 上 `NavigationBar` tooltip 行为带来的异常视觉表现。
   - 通过禁用底部栏 tooltip 显示策略修复，并回归验证通过。

4. **定位并修复 `TweenSequence` 断言崩溃**
   - 报错：`t >= 0.0 && t <= 1.0`（`article_detail_screen.dart` 动画链路）。
   - 根因：`TweenSequence` 外层使用可能越界的曲线驱动（`elastic` 类曲线）。
   - 修复：改为 controller 直接驱动 `TweenSequence`，并把曲线下沉到每段 `CurveTween`。
   - 同时补了回归测试，防止再次引入该类问题。

5. **浏览器实测后开展交互/性能优化（阶段一）**
   - 实测发现 tab 切换体感偏慢、首屏请求偏重。
   - 落地两项高优先优化：
     - `_search()` 增加防抖 + 请求去重；
     - feed/saved 列表改为 `ListView.builder` 惰性构建。

6. **落实你要求的 1~5 全量优化（阶段二）**
   - 继续完成：
     - 阅读时长预计算到模型层（避免 card build 时重复 regex）；
     - Profile 脉冲动画仅在 Profile tab 可见时运行；
     - Web 字体/图片策略优化（含缓存尺寸、请求量控制、字体链路优化）。
   - 并额外移除首页启动阶段分类预取，降低首屏额外请求。

7. **完成本地 CJK 字体子集化**
   - 生成本地子集字体资源并接入主题字体配置。
   - 语料覆盖项目中文文案 + 内容样本，显著小于原始大字体文件。
   - 完成 `pub get / test / analyze / build web` 全流程验证。

8. **排查 Android 真机运行链路问题**
   - 先后定位到三类问题：
     - Windows 路径（空格/引号）引发命令解析异常；
     - Gradle 网络下载 Flutter AAR 超时/连接重置；
     - 最终阻塞为手机端安装授权被拒（`INSTALL_FAILED_ABORTED`）。
   - 提供安全路径运行与网络/代理侧修复思路后，已到“构建成功但待手机确认安装”的阶段。

9. **修复你新增的体验诉求**
   - 文章详情页表格在手机竖屏可读性问题：为 `<table>` 增加横向滚动包装，适配列数不一致场景。
   - 增加左划返回与关键交互震动反馈（返回按钮、左划返回、链接点击等）。

10. **补齐左划返回正反向测试**
   - 正例：左边缘滑动触发返回。
   - 负例：非左边缘横向拖动不触发返回。
   - 测试集扩展到 8 条并通过。

---

## 三、关键决策与原因

1. **优先“先测再改”**
   - 先跑 test/analyze/build 和浏览器实测，避免盲改；确保每次修改都有可验证基线。

2. **将易抖动交互纳入自动化测试**
   - 对导航、详情返回、动画稳定性、边缘手势补回归测试，防止体验问题回潮。

3. **把性能优化拆成“交互响应优先 + 首屏负载优化”两层**
   - 先改善体感（防抖、列表惰性），再降低网络/资源负载（字体、图片、首屏请求）。

4. **针对 Windows 环境问题采用“安全路径映射”策略**
   - 使用 `subst` 避开路径字符导致的命令解析问题，先保证可跑通流程。

5. **表格问题采取最小侵入方案**
   - 不改服务端内容结构，前端通过表格横向容器增强竖屏可读性，风险低、见效快。

---

## 四、遇到的问题与解决方式

1. **`TweenSequence` 断言崩溃**
   - 现象：运行时持续抛 `t >= 0.0 && t <= 1.0`。
   - 解决：调整动画组合方式，避免越界输入；补回归测试。

2. **底部栏 hover 出现异常方块**
   - 现象：鼠标悬停底部导航出现不期望 tooltip 方块。
   - 解决：禁用该区域 tooltip 显示策略，保留点击交互。

3. **Android `flutter run` 多阶段失败**
   - 阶段A：路径字符导致 hook 命令解析失败；
   - 阶段B：Gradle 下载 Flutter AAR 超时/重置；
   - 阶段C：APK 安装被手机拒绝授权。
   - 解决：安全路径运行、网络/超时策略增强、引导手机端安装授权。

4. **表格竖屏显示不佳（列数不一致）**
   - 现象：小屏阅读时表格排版拥挤或错位。
   - 解决：表格包裹横向滚动并保证最小宽度，支持内容可滑动阅读。

---

## 五、当前状态 / 结论

- UI/交互核心问题已处理：
  - 动画崩溃已修复；
  - 底部栏 hover 异常已修复；
  - 表格竖屏可读性已增强；
  - 左划返回与震动反馈已落地。
- 性能优化已落地到代码与资源层：
  - 搜索防抖+请求去重；
  - 列表惰性构建；
  - 阅读时长预计算；
  - Profile 动画可见性控制；
  - 字体/图片/首屏请求优化；
  - CJK 本地子集化完成。
- 自动化测试覆盖已提升，并新增了关键手势正反用例。
- Android 真机运行链路已推进到“可构建，待手机端安装授权确认”。

---

## 六、后续可执行动作

1. **Android 端收尾（优先）**
   - 在手机上确认安装授权（或开启 USB 安装相关权限），再次 `flutter run -d V2243A`。

2. **稳定化执行脚本**
   - 固化安全路径运行脚本（如 `run-android.ps1`），避免路径字符问题重复出现。

3. **测试继续补强**
   - 增加表格渲染在不同屏宽下的 UI 回归测试；
   - 增加关键震动反馈触发路径的行为测试（可通过可观察副作用间接断言）。

4. **性能持续观测**
   - 对首屏与 tab 切换建立固定度量（请求数、首帧时间、交互延迟），形成迭代基线。

5. **字体子集维护机制**
   - 将语料更新与子集生成流程文档化/脚本化，避免新文案导致缺字风险。
